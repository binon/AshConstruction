<!DOCTYPE html>
<html>
<head>
  <title>AshConstruction - Invoice Entry System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #007bff;
      padding-bottom: 20px;
    }
    
    .header h1 {
      color: #007bff;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 1.1em;
    }
    
    .form-section {
      margin-bottom: 25px;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fafafa;
    }
    
    .form-section h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3em;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 5px rgba(0,123,255,0.3);
    }
    
    .line-items {
      margin: 20px 0;
    }
    
    .line-item {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .line-item input {
      flex: 1;
      min-width: 100px;
    }
    
    .remove-item {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .add-item {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    
    .summary {
      background: #e9ecef;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .summary-row.total {
      font-weight: bold;
      font-size: 18px;
      border-top: 2px solid #007bff;
      padding-top: 10px;
      margin-top: 15px;
    }
    
    .file-upload {
      border: 2px dashed #007bff;
      padding: 20px;
      text-align: center;
      border-radius: 8px;
      background: #f8f9fa;
    }
    
    .file-upload input[type="file"] {
      margin: 10px 0;
    }
    
    .submit-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 5px;
      font-size: 18px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
    }
    
    .submit-btn:hover {
      background: #0056b3;
    }
    
    #response {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }
    
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    @media (max-width: 600px) {
      .form-row {
        flex-direction: column;
      }
      
      .line-item {
        flex-direction: column;
      }
      
      .container {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèóÔ∏è AshConstruction</h1>
      <p>Professional Invoice Entry System</p>
    </div>
    
    <form id="invoiceForm">
      <!-- Invoice Header Section -->
      <div class="form-section">
        <h3>üìã Invoice Information</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="invoiceNumber">Invoice Number *</label>
            <input type="text" id="invoiceNumber" name="invoiceNumber" required placeholder="INV-001">
          </div>
          <div class="form-group">
            <label for="invoiceDate">Invoice Date *</label>
            <input type="date" id="invoiceDate" name="invoiceDate" required>
          </div>
          <div class="form-group">
            <label for="dueDate">Due Date</label>
            <input type="date" id="dueDate" name="dueDate">
          </div>
        </div>
      </div>

      <!-- Client & Project Selection Section -->
      <div class="form-section">
        <h3>üë§ Client & Project Selection</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="selectedClient">Select Client *</label>
            <select id="selectedClient" name="selectedClient" required>
              <option value="">Choose a client...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="selectedProject">Select Project</label>
            <select id="selectedProject" name="selectedProject">
              <option value="">Choose a project...</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <div style="display: flex; gap: 10px; align-items: center;">
              <a href="client.html" style="display: inline-block; padding: 8px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
                ‚ûï Manage Clients & Projects
              </a>
              <button type="button" id="refreshData" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                üîÑ Refresh
              </button>
            </div>
          </div>
        </div>
        <div id="clientProjectInfo" style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
          <h4 style="margin-bottom: 10px; color: #333;">Selected Details:</h4>
          <div id="clientInfo"></div>
          <div id="projectInfo"></div>
        </div>
      </div>

      <!-- Line Items Section -->
      <div class="form-section">
        <h3>üìù Invoice Items</h3>
        <div class="line-items" id="lineItems">
          <div class="line-item">
            <input type="text" name="itemDescription[]" placeholder="Description of work/materials" required>
            <input type="number" name="itemQuantity[]" placeholder="Qty" min="0" step="0.01" required>
            <input type="text" name="itemUnit[]" placeholder="Unit" value="hrs">
            <input type="number" name="itemRate[]" placeholder="Rate" min="0" step="0.01" required>
            <input type="number" name="itemAmount[]" placeholder="Amount" readonly class="item-amount">
            <button type="button" class="remove-item" onclick="removeItem(this)">√ó</button>
          </div>
        </div>
        <button type="button" class="add-item" onclick="addItem()">+ Add Item</button>
        
        <div class="summary">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span id="subtotal">¬£0.00</span>
          </div>
          <div class="summary-row">
            <span>Tax Rate (%):</span>
            <input type="number" id="taxRate" name="taxRate" value="20" min="0" step="0.1" style="width: 80px; text-align: right;">
          </div>
          <div class="summary-row">
            <span>Tax Amount:</span>
            <span id="taxAmount">¬£0.00</span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span id="total">¬£0.00</span>
          </div>
        </div>
      </div>

      <!-- Document Upload Section -->
      <div class="form-section">
        <h3>üìé Supporting Documents</h3>
        <div class="file-upload">
          <p>Upload receipts, contracts, photos, or other supporting documents</p>
          <input type="file" id="documents" name="documents" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls">
          <p><small>Supported formats: PDF, DOC, DOCX, JPG, PNG, XLS, XLSX</small></p>
        </div>
      </div>

      <!-- Notes Section -->
      <div class="form-section">
        <h3>üí¨ Additional Notes</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="notes">Notes/Comments</label>
            <textarea id="notes" name="notes" rows="4" placeholder="Payment terms, special instructions, etc."></textarea>
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn">üíæ Save Invoice</button>
    </form>
    
    <div id="response"></div>
  </div>

  <script>
    // Set current date as default
    document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
    
    // Generate invoice number
    function generateInvoiceNumber() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const time = String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0');
      return `ASH-${year}${month}${day}-${time}`;
    }
    
    // Set default invoice number
    document.getElementById('invoiceNumber').value = generateInvoiceNumber();

    // Client and Project Management - now using Google Sheets
    let clients = [];
    let projects = [];
    let isLoading = false;
    
    // Google Apps Script configuration
    const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzJY-vfHNj_4LQ3vwy443cyOX9pqsxZxEdzo1RV2cwNP2sqvXBVIXUhzl8Y2ogmODWW/exec";
    
    // Google Sheets API Helper Functions
    async function makeGoogleSheetsRequest(action, data = {}) {
      const requestData = new URLSearchParams();
      requestData.append('action', action);
      
      Object.keys(data).forEach(key => {
        if (data[key] !== null && data[key] !== undefined) {
          requestData.append(key, data[key]);
        }
      });

      try {
        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
          },
          body: requestData.toString()
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Google Sheets API request failed:', error);
        throw error;
      }
    }
    
    function loadClientProjectData() {
      loadDataFromGoogleSheets();
    }
    
    async function loadDataFromGoogleSheets() {
      if (isLoading) return;
      
      isLoading = true;
      
      try {
        // Show loading message
        const responseDiv = document.getElementById("response");
        responseDiv.innerHTML = '<div style="background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 15px; border-radius: 5px;">‚è≥ Loading client and project data from Google Sheets...</div>';
        
        // Load both clients and projects
        const [clientsResponse, projectsResponse] = await Promise.all([
          makeGoogleSheetsRequest('getClients'),
          makeGoogleSheetsRequest('getProjects')
        ]);
        
        if (clientsResponse.status === 'success') {
          clients = clientsResponse.data || [];
        } else {
          console.warn('Failed to load clients from Google Sheets, using localStorage fallback');
          clients = JSON.parse(localStorage.getItem('ashClients') || '[]');
        }
        
        if (projectsResponse.status === 'success') {
          projects = projectsResponse.data || [];
        } else {
          console.warn('Failed to load projects from Google Sheets, using localStorage fallback');
          projects = JSON.parse(localStorage.getItem('ashProjects') || '[]');
        }
        
        populateClientDropdown();
        responseDiv.innerHTML = '<div class="success">‚úÖ Data loaded successfully from Google Sheets!</div>';
        setTimeout(() => {
          responseDiv.innerHTML = '';
        }, 2000);
        
      } catch (error) {
        console.error('Error loading data from Google Sheets:', error);
        
        // Fallback to localStorage
        clients = JSON.parse(localStorage.getItem('ashClients') || '[]');
        projects = JSON.parse(localStorage.getItem('ashProjects') || '[]');
        populateClientDropdown();
        
        const responseDiv = document.getElementById("response");
        responseDiv.innerHTML = '<div style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px;">‚ö†Ô∏è Using offline data. Google Sheets connection failed.</div>';
        setTimeout(() => {
          responseDiv.innerHTML = '';
        }, 3000);
      } finally {
        isLoading = false;
      }
    }
    
    function populateClientDropdown() {
      const clientSelect = document.getElementById('selectedClient');
      const currentValue = clientSelect.value;
      
      clientSelect.innerHTML = '<option value="">Choose a client...</option>';
      
      clients.forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = client.name;
        clientSelect.appendChild(option);
      });
      
      // Restore selected value if it still exists
      if (currentValue && clients.find(c => c.id === currentValue)) {
        clientSelect.value = currentValue;
        onClientSelected(); // Trigger project loading
      }
    }
    
    function populateProjectDropdown(clientId) {
      const projectSelect = document.getElementById('selectedProject');
      projectSelect.innerHTML = '<option value="">Choose a project...</option>';
      
      const clientProjects = projects.filter(p => p.clientId === clientId);
      clientProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.id;
        option.textContent = project.name;
        projectSelect.appendChild(option);
      });
    }
    
    function onClientSelected() {
      const clientSelect = document.getElementById('selectedClient');
      const clientId = clientSelect.value;
      
      if (clientId) {
        populateProjectDropdown(clientId);
        updateClientProjectInfo();
      } else {
        document.getElementById('selectedProject').innerHTML = '<option value="">Choose a project...</option>';
        document.getElementById('clientProjectInfo').style.display = 'none';
      }
    }
    
    function onProjectSelected() {
      updateClientProjectInfo();
    }
    
    function updateClientProjectInfo() {
      const clientId = document.getElementById('selectedClient').value;
      const projectId = document.getElementById('selectedProject').value;
      const infoDiv = document.getElementById('clientProjectInfo');
      const clientInfoDiv = document.getElementById('clientInfo');
      const projectInfoDiv = document.getElementById('projectInfo');
      
      if (!clientId) {
        infoDiv.style.display = 'none';
        return;
      }
      
      const client = clients.find(c => c.id === clientId);
      const project = projects.find(p => p.id === projectId);
      
      let clientHtml = '';
      let projectHtml = '';
      
      if (client) {
        clientHtml = `
          <div style="margin-bottom: 10px;">
            <strong>Client:</strong> ${client.name}<br>
            ${client.contact ? `<strong>Contact:</strong> ${client.contact}<br>` : ''}
            ${client.email ? `<strong>Email:</strong> ${client.email}<br>` : ''}
            ${client.phone ? `<strong>Phone:</strong> ${client.phone}<br>` : ''}
            ${client.address ? `<strong>Address:</strong> ${client.address}` : ''}
          </div>
        `;
      }
      
      if (project) {
        projectHtml = `
          <div>
            <strong>Project:</strong> ${project.name}<br>
            ${project.address ? `<strong>Location:</strong> ${project.address}<br>` : ''}
            ${project.description ? `<strong>Description:</strong> ${project.description}` : ''}
          </div>
        `;
      }
      
      if (clientHtml || projectHtml) {
        clientInfoDiv.innerHTML = clientHtml;
        projectInfoDiv.innerHTML = projectHtml;
        infoDiv.style.display = 'block';
      } else {
        infoDiv.style.display = 'none';
      }
    }
    
    // Event listeners for dropdowns
    document.getElementById('selectedClient').addEventListener('change', onClientSelected);
    document.getElementById('selectedProject').addEventListener('change', onProjectSelected);
    document.getElementById('refreshData').addEventListener('click', loadClientProjectData);

    // Add new line item
    function addItem() {
      const lineItems = document.getElementById('lineItems');
      const newItem = document.createElement('div');
      newItem.className = 'line-item';
      newItem.innerHTML = `
        <input type="text" name="itemDescription[]" placeholder="Description of work/materials" required>
        <input type="number" name="itemQuantity[]" placeholder="Qty" min="0" step="0.01" required>
        <input type="text" name="itemUnit[]" placeholder="Unit" value="hrs">
        <input type="number" name="itemRate[]" placeholder="Rate" min="0" step="0.01" required>
        <input type="number" name="itemAmount[]" placeholder="Amount" readonly class="item-amount">
        <button type="button" class="remove-item" onclick="removeItem(this)">√ó</button>
      `;
      lineItems.appendChild(newItem);
      attachCalculationListeners(newItem);
    }

    // Remove line item
    function removeItem(button) {
      const lineItems = document.getElementById('lineItems');
      if (lineItems.children.length > 1) {
        button.parentElement.remove();
        calculateTotals();
      }
    }

    // Attach calculation listeners to inputs
    function attachCalculationListeners(item) {
      const qtyInput = item.querySelector('input[name="itemQuantity[]"]');
      const rateInput = item.querySelector('input[name="itemRate[]"]');
      
      qtyInput.addEventListener('input', () => calculateItemAmount(item));
      rateInput.addEventListener('input', () => calculateItemAmount(item));
    }

    // Calculate individual item amount
    function calculateItemAmount(item) {
      const qty = parseFloat(item.querySelector('input[name="itemQuantity[]"]').value) || 0;
      const rate = parseFloat(item.querySelector('input[name="itemRate[]"]').value) || 0;
      const amount = qty * rate;
      
      item.querySelector('.item-amount').value = amount.toFixed(2);
      calculateTotals();
    }

    // Calculate totals
    function calculateTotals() {
      const amounts = document.querySelectorAll('.item-amount');
      let subtotal = 0;
      
      amounts.forEach(amount => {
        subtotal += parseFloat(amount.value) || 0;
      });
      
      const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
      const taxAmount = subtotal * (taxRate / 100);
      const total = subtotal + taxAmount;
      
      document.getElementById('subtotal').textContent = `¬£${subtotal.toFixed(2)}`;
      document.getElementById('taxAmount').textContent = `¬£${taxAmount.toFixed(2)}`;
      document.getElementById('total').textContent = `¬£${total.toFixed(2)}`;
    }

    // Initialize calculation listeners for existing items
    document.addEventListener('DOMContentLoaded', function() {
      const existingItems = document.querySelectorAll('.line-item');
      existingItems.forEach(item => attachCalculationListeners(item));
      
      // Tax rate change listener
      document.getElementById('taxRate').addEventListener('input', calculateTotals);
      
      // Load client and project data
      loadClientProjectData();
    });

    // Form submission
    const form = document.getElementById("invoiceForm");
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      
      // Validate client selection
      const clientId = document.getElementById('selectedClient').value;
      if (!clientId) {
        document.getElementById("response").innerHTML = '<div class="error">‚ùå Please select a client before submitting the invoice.</div>';
        return;
      }
      
      const responseDiv = document.getElementById("response");
      responseDiv.innerHTML = '<div style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px;">‚è≥ Saving invoice...</div>';

      // Collect form data
      const formData = new FormData(form);
      
      // Add selected client and project information
      const projectId = document.getElementById('selectedProject').value;
      
      if (clientId) {
        const selectedClient = clients.find(c => c.id === clientId);
        if (selectedClient) {
          formData.append('clientName', selectedClient.name);
          formData.append('clientContact', selectedClient.contact || '');
          formData.append('clientEmail', selectedClient.email || '');
          formData.append('clientPhone', selectedClient.phone || '');
          formData.append('billingAddress', selectedClient.address || '');
        }
      }
      
      if (projectId) {
        const selectedProject = projects.find(p => p.id === projectId);
        if (selectedProject) {
          formData.append('projectName', selectedProject.name);
          formData.append('projectAddress', selectedProject.address || '');
          formData.append('projectDescription', selectedProject.description || '');
        }
      }
      
      // Add calculated totals
      formData.append('subtotal', document.getElementById('subtotal').textContent);
      formData.append('taxAmount', document.getElementById('taxAmount').textContent);
      formData.append('total', document.getElementById('total').textContent);
      
      // Collect line items
      const items = [];
      const descriptions = formData.getAll('itemDescription[]');
      const quantities = formData.getAll('itemQuantity[]');
      const units = formData.getAll('itemUnit[]');
      const rates = formData.getAll('itemRate[]');
      const amounts = formData.getAll('itemAmount[]');
      
      for (let i = 0; i < descriptions.length; i++) {
        if (descriptions[i].trim()) {
          items.push({
            description: descriptions[i],
            quantity: quantities[i],
            unit: units[i],
            rate: rates[i],
            amount: amounts[i]
          });
        }
      }
      
      formData.append('lineItems', JSON.stringify(items));

      // Handle file uploads
      const files = document.getElementById('documents').files;
      if (files.length > 0) {
        // For now, we'll just collect file names and sizes
        // In a full implementation, you'd upload to Google Drive
        const fileInfo = Array.from(files).map(file => ({
          name: file.name,
          size: file.size,
          type: file.type
        }));
        formData.append('attachments', JSON.stringify(fileInfo));
        
        // Note: File upload to Google Drive would require additional Google Apps Script setup
        responseDiv.innerHTML += '<div style="background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; padding: 10px; border-radius: 5px; margin-top: 10px;">üìé Note: File upload integration requires Google Drive API setup in Google Apps Script</div>';
      }

      // Convert FormData to URLSearchParams for the existing endpoint
      const data = new URLSearchParams();
      for (let [key, value] of formData.entries()) {
        if (key !== 'documents') { // Skip file input
          data.append(key, value);
        }
      }

      fetch("https://script.google.com/macros/s/AKfycbzJY-vfHNj_4LQ3vwy443cyOX9pqsxZxEdzo1RV2cwNP2sqvXBVIXUhzl8Y2ogmODWW/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body: data.toString()
      })
      .then(res => res.json())
      .then(res => {
        if (res.status === "success") {
          responseDiv.innerHTML = '<div class="success">‚úÖ Invoice saved successfully to Google Sheets!</div>';
          
          // Clear any saved drafts after successful submission
          makeGoogleSheetsRequest('clearDraft').catch(console.warn);
          localStorage.removeItem('invoiceDraft');
          
          // Don't reset form immediately, let user review
          setTimeout(() => {
            if (confirm('Invoice saved! Would you like to create a new invoice?')) {
              form.reset();
              document.getElementById('invoiceNumber').value = generateInvoiceNumber();
              document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
              calculateTotals();
            }
          }, 2000);
        } else {
          responseDiv.innerHTML = '<div class="error">‚ùå Error saving invoice: ' + (res.message || 'Unknown error') + '</div>';
        }
      })
      .catch(err => {
        responseDiv.innerHTML = '<div class="error">‚ùå Network error: ' + err.message + '</div>';
      });
    });

    // Validation helpers
    function validateForm() {
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;
      
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          field.style.borderColor = '#dc3545';
          isValid = false;
        } else {
          field.style.borderColor = '#ddd';
        }
      });
      
      return isValid;
    }

    // Auto-save to Google Sheets (enhanced feature)
    let autoSaveTimeout;
    
    function autoSave() {
      if (isLoading) return;
      
      const formData = new FormData(form);
      const data = {};
      for (let [key, value] of formData.entries()) {
        data[key] = value;
      }
      
      // Only auto-save if there's substantial content
      if (data.clientName || data.projectName || data.invoiceNumber) {
        data.isDraft = 'true';
        data.lastSaved = new Date().toISOString();
        
        // Save to Google Sheets as draft
        makeGoogleSheetsRequest('saveDraft', data)
          .then(response => {
            if (response.status === 'success') {
              console.log('Draft auto-saved to Google Sheets');
              // Also save to localStorage as backup
              localStorage.setItem('invoiceDraft', JSON.stringify(data));
            } else {
              throw new Error('Failed to auto-save');
            }
          })
          .catch(error => {
            console.warn('Auto-save to Google Sheets failed, using localStorage:', error);
            localStorage.setItem('invoiceDraft', JSON.stringify(data));
          });
      }
    }

    // Load draft from Google Sheets or localStorage
    async function loadDraft() {
      if (isLoading) return;
      
      try {
        const response = await makeGoogleSheetsRequest('getDraft');
        
        if (response.status === 'success' && response.data && confirm('Load saved draft from Google Sheets?')) {
          const data = response.data;
          Object.keys(data).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input && key !== 'isDraft' && key !== 'lastSaved') {
              input.value = data[key];
            }
          });
          calculateTotals();
          return;
        }
      } catch (error) {
        console.warn('Failed to load draft from Google Sheets:', error);
      }
      
      // Fallback to localStorage
      const draft = localStorage.getItem('invoiceDraft');
      if (draft && confirm('Load saved draft?')) {
        const data = JSON.parse(draft);
        Object.keys(data).forEach(key => {
          const input = form.querySelector(`[name="${key}"]`);
          if (input && key !== 'isDraft' && key !== 'lastSaved') input.value = data[key];
        });
        calculateTotals();
      }
    }

    // Call loadDraft on page load and load client/project data
    window.addEventListener('load', async () => {
      await loadDataFromGoogleSheets();
      loadDraft();
    });

    // Auto-save with debouncing - save 5 seconds after user stops typing
    function scheduleAutoSave() {
      if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
      }
      autoSaveTimeout = setTimeout(autoSave, 5000);
    }
    
    // Add auto-save listeners to form inputs
    document.addEventListener('DOMContentLoaded', function() {
      const formInputs = form.querySelectorAll('input, textarea, select');
      formInputs.forEach(input => {
        input.addEventListener('input', scheduleAutoSave);
        input.addEventListener('change', scheduleAutoSave);
      });
    });
  </script>
</body>
</html>
